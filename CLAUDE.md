# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

MoneyTrak is a Spring Boot-based money tracking application built with Java 25. It provides RESTful APIs for tracking financial transactions (income and expenses) with categories, validation, optimistic locking, and standardized error handling. The application supports categorized transaction management with 14 predefined categories, transaction type classification (INCOME/EXPENSE), and transaction stability tracking (FIXED/VARIABLE).

## Build & Development Commands

### Maven Wrapper
This project uses Maven wrapper (`mvnw`). All commands use `./mvnw` on macOS/Linux or `mvnw.cmd` on Windows.

### Common Commands
- **Build the project**: `./mvnw clean package`
- **Run the application**: `./mvnw spring-boot:run`
- **Run tests**: `./mvnw test`
- **Run a single test**: `./mvnw test -Dtest=ClassName#methodName`
- **Compile only**: `./mvnw compile`
- **Clean build directory**: `./mvnw clean`

## Architecture

### Technology Stack
- Spring Boot 4.0.1
- Java 25
- Spring Web MVC for REST APIs
- Spring Data JPA for persistence
- H2 Database (file-based for production, in-memory for tests)
- Flyway for database migrations
- Jakarta Validation for request validation
- Hibernate ORM 7.2.0 with optimistic locking
- Configuration processor enabled for type-safe configuration properties

### Package Structure
The codebase follows a feature-based package structure under `dev.juanvaldivia.moneytrak`:
- `transactions/` - Transaction management feature (income and expenses) with controller, service, domain models, DTOs, and enums
- `categories/` - Category management feature for organizing transactions
- `security/` - Authentication and authorization infrastructure (SecurityConfig, SecurityProperties, SecurityUserDetailsService, CustomAuthEntryPoint, CustomAccessDeniedHandler)
- `exception/` - Shared exception handling infrastructure (GlobalExceptionHandler, NotFoundException, ConflictException, error DTOs)
- `validation/` - Custom validation annotations (e.g., @ValidCurrency)

### Core Patterns

**Service Layer Pattern**: Interface-based services (e.g., `TransactionService`/`LocalTransactionService`, `CategoryService`/`LocalCategoryService`) enable multiple implementations and easier testing.

**DTO Pattern**: Separate DTOs for API contracts:
- **Transactions**:
  - `TransactionCreationDto` - Input validation for POST with optional categoryId, transactionType, transactionStability
  - `TransactionUpdateDto` - Partial update DTO with version field for optimistic locking
  - `TransactionDto` - API response with transaction details, category info, type, and stability
  - `Transaction` - JPA entity with @ManyToOne Category relationship
  - `TransactionMapper` - Maps between DTOs and domain models, handles category resolution
- **Categories**:
  - `CategoryCreationDto` - Input validation for creating custom categories
  - `CategoryUpdateDto` - Update DTO with version for optimistic locking
  - `CategoryDto` - API response with category details and isPredefined flag
  - `Category` - JPA entity with predefined/custom distinction
  - `CategoryMapper` - Maps between DTOs and domain models

**Controller Design**: REST controllers use:
- `@Valid` for automatic validation of request bodies
- `ResponseEntity` for HTTP response control
- `ServletUriComponentsBuilder` for generating resource URIs in `Location` headers

### Domain Model Conventions
- Records are used for immutable DTOs (e.g., `TransactionDto`, `CategoryDto`)
- JPA entities are mutable classes (e.g., `Transaction`, `Category` with @Entity annotation)
- `BigDecimal` for monetary amounts with precision constraints (11 digits, 2 decimal places)
- ISO 4217 currency codes validated with custom `@ValidCurrency` annotation
- `ZonedDateTime` for temporal data with timezone support (stored in UTC)
- UUID for entity identifiers (generated by JPA)
- `@Version` field for optimistic locking with automatic increment
- Enums stored as strings (`@Enumerated(EnumType.STRING)`) for extensibility:
  - `TransactionType` - EXPENSE (default) or INCOME
  - `TransactionStability` - VARIABLE (default) or FIXED
- `@ManyToOne` relationship from Transaction to Category (unidirectional)
- Default category assignment: transactions without a category default to "Others"

### Validation Rules
Validation is declarative using Jakarta Validation annotations on DTOs:
- `@NotNull`, `@NotBlank` for required fields
- `@PastOrPresent` for date validation (rejects future dates)
- `@Size(max=500)` for description length
- `@DecimalMin("0.01")` for positive amounts
- `@Digits(integer=9, fraction=2)` for decimal precision
- Custom `@ValidCurrency` for ISO 4217 currency code validation
- Custom error messages provided for each validation rule

### API Versioning
REST endpoints are versioned using path prefix `/v1/` (e.g., `/v1/transactions`, `/v1/categories`).

### API Endpoints

**Transactions** (`/v1/transactions`):
- `POST /v1/transactions` - Create new transaction (returns 201 with Location header)
  - Optional: categoryId (defaults to "Others"), transactionType (defaults to EXPENSE), transactionStability (defaults to VARIABLE)
- `GET /v1/transactions` - List all transactions (reverse chronological order)
  - Query params: `categoryId` (filter by category), `stability` (filter by FIXED/VARIABLE)
- `GET /v1/transactions/{id}` - Get single transaction by ID with category details
- `PUT /v1/transactions/{id}` - Update transaction (requires version for optimistic locking)
- `DELETE /v1/transactions/{id}` - Delete transaction (returns 204 No Content)
- `GET /v1/transactions/summary/expenses` - Get total of all EXPENSE transactions
- `GET /v1/transactions/summary/income` - Get total of all INCOME transactions

**Categories** (`/v1/categories`):
- `POST /v1/categories` - Create new custom category (returns 201 with Location header)
- `GET /v1/categories` - List all categories (14 predefined + custom)
- `GET /v1/categories/{id}` - Get single category by ID
- `PUT /v1/categories/{id}` - Update category name (requires version for optimistic locking)
  - Predefined categories can be renamed but maintain isPredefined=true
- `DELETE /v1/categories/{id}` - Delete category (returns 409 if transactions exist)

### Authentication & Authorization
HTTP Basic Authentication with three roles, configured via `application.yaml`:

**Roles**:
- **APP**: Read-only access to `/v1/**` endpoints (GET only)
- **BACKOFFICE**: Full CRUD access to `/v1/**` endpoints (GET, POST, PUT, DELETE)
- **ADMIN**: Full CRUD access + actuator endpoints + H2 console access

**Role Permission Matrix**:

| Operation | APP | BACKOFFICE | ADMIN |
|-----------|-----|------------|-------|
| GET /v1/** | Yes | Yes | Yes |
| POST/PUT/DELETE /v1/** | No (403) | Yes | Yes |
| GET /actuator/health | Public | Public | Public |
| GET /actuator/** (other) | No (403) | No (403) | Yes |
| /h2-console/** | No (403) | No (403) | Yes |

**Configuration**: Users defined in `moneytrak.security.users` with BCrypt-hashed passwords (production) or `{noop}` plaintext (test profile). Uses `InMemoryUserDetailsManager` — no database table.

**Security Classes** (`security/` package):
- `SecurityConfig` - `SecurityFilterChain` bean with URL-based authorization rules
- `SecurityProperties` - `@ConfigurationProperties` record for user configuration
- `SecurityUserDetailsService` - Maps config users to Spring `UserDetails`
- `CustomAuthEntryPoint` - JSON 401 responses + failed auth logging (FR-014)
- `CustomAccessDeniedHandler` - JSON 403 responses

**Error Responses**: Auth errors use existing `ErrorResponseDto` format:
- 401 Unauthorized: `{status: 401, error: "Unauthorized", message: "Authentication required. Provide valid credentials.", details: []}`
- 403 Forbidden: `{status: 403, error: "Forbidden", message: "Access denied. Insufficient permissions for this operation.", details: []}`

**Test Users** (application-test.yaml):
- `app-client` / `app-client` (role: APP)
- `backoffice` / `backoffice` (role: BACKOFFICE)
- `admin` / `admin` (role: ADMIN)

### Error Handling
Global exception handler (`@RestControllerAdvice`) provides consistent error responses:
- 400 Bad Request - Validation errors with field-level details
- 401 Unauthorized - Missing or invalid credentials (via CustomAuthEntryPoint)
- 403 Forbidden - Valid credentials but insufficient role permissions (via CustomAccessDeniedHandler)
- 404 Not Found - Resource not found (transaction, category, invalid category reference)
- 409 Conflict - Optimistic lock version mismatch, category in use (cannot delete), duplicate category name
- 500 Internal Server Error - Unexpected errors

Error response format: `{status, error, message, details[]}`

**Category Deletion Rules**: Categories with linked transactions cannot be deleted (returns 409 Conflict with transaction count)

### Optimistic Locking
Uses JPA `@Version` field with automatic increment:
- Version starts at 0 on creation
- Increments on each update
- Concurrent updates with stale version return 409 Conflict
- EntityManager.flush() called after updates to ensure version increment

### Configuration
- `application.yaml` in `src/main/resources/` for Spring configuration
- Spring Boot Configuration Processor generates metadata for IDE autocomplete

## Active Technologies
- Java 25 + Spring Boot 4.0.1
- Spring Security 7.0.2 (via `spring-boot-starter-security`) — HTTP Basic Authentication
- Spring Web MVC, Spring Data JPA, Jakarta Validation
- H2 database (file-based for persistence, in-memory for tests)
- Hibernate ORM 7.2.0 with optimistic locking
- Flyway for database migrations
- Spring Boot Configuration Processor

### Database Migrations
- Flyway manages schema migrations in `src/main/resources/db/migration/`
- V1: Initial expense schema (deprecated)
- V2: Migration to transaction categories
  - Creates categories table with 14 predefined categories
  - Renames expenses → transactions
  - Adds transaction_type, transaction_stability, category_id columns
  - Migrates existing data with defaults (EXPENSE, VARIABLE, "Others" category)
  - Adds foreign key constraints and indexes

### Predefined Categories (Seeded on Startup)
14 categories are automatically created with `isPredefined=true`:
1. Office Renting, 2. Public Transport, 3. Bank, 4. Car Maintenance, 5. Food & Drinks, 6. Subscriptions, 7. Supermarket, 8. Tolls, 9. Gas, 10. Sport, 11. Gifts, 12. ATM, 13. Video & Films, 14. Transfers, 15. **Others** (default)

## Test Coverage
- 63 integration tests covering all features
  - 7 category controller tests (CRUD, deletion validation, uniqueness)
  - 1 category integration test (seeding verification)
  - 19 transaction controller tests (category linking, types, stability)
  - 1 final integration test (end-to-end all user stories)
  - 1 application context test
  - 2 security smoke tests (basic auth/no-auth)
  - 32 security integration tests:
    - 6 US1 authentication tests (no-auth 401, invalid credentials, valid credentials, malformed header)
    - 10 US2 APP role tests (read-only access, write operations return 403)
    - 8 US3 BACKOFFICE role tests (full CRUD, actuator denied)
    - 4 US4 ADMIN role tests (actuator access, full CRUD)
    - 3 US5 health check tests (public health endpoint, other endpoints require auth)
    - 1 failed auth logging test (401 response format validation)
- Test profiles: `test` (in-memory H2), `default` (file-based H2)

## Recent Changes
- **003-simple-auth**: Complete role-based authentication implementation
  - HTTP Basic Authentication with 3 roles: APP (read-only), BACKOFFICE (full CRUD), ADMIN (full access + actuator)
  - Config-based users via `@ConfigurationProperties` with BCrypt password hashing
  - URL-based authorization rules in centralized `SecurityFilterChain`
  - Custom JSON error responses for 401/403 matching existing `ErrorResponseDto` format
  - Failed authentication logging (username, IP, timestamp) at WARN level
  - Health endpoint (`/actuator/health`) remains publicly accessible
  - 32 new security integration tests covering all acceptance scenarios
  - All 31 existing tests pass (zero regressions)
  - Required `spring-boot-starter-security-test` for Spring Boot 4 MockMvc + security integration
- **002-transaction-categories**: Complete transaction categories and types implementation
  - User Story 1: Category management (CRUD, 14 predefined categories)
  - User Story 2: Transaction-category linking with default "Others" assignment
  - User Story 3: Transaction types (EXPENSE vs INCOME) with summary endpoints
  - User Story 4: Transaction stability (FIXED vs VARIABLE) with filtering
  - User Story 5: Migration from Expense to Transaction model
  - Flyway database migrations with zero data loss
  - All old /v1/expenses endpoints removed (404 Not Found)
  - New /v1/transactions and /v1/categories endpoints with filtering
  - All 4 user stories implemented (Create, Retrieve, Update, Delete)
  - 32 passing integration tests
  - JavaDoc added to public APIs
  - Global exception handling with standardized error responses
