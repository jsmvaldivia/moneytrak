# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

MoneyTrak is a Spring Boot-based money tracking application built with Java 25. It provides RESTful APIs for complete CRUD operations on expense records with validation, optimistic locking, and standardized error handling.

## Build & Development Commands

### Maven Wrapper
This project uses Maven wrapper (`mvnw`). All commands use `./mvnw` on macOS/Linux or `mvnw.cmd` on Windows.

### Common Commands
- **Build the project**: `./mvnw clean package`
- **Run the application**: `./mvnw spring-boot:run`
- **Run tests**: `./mvnw test`
- **Run a single test**: `./mvnw test -Dtest=ClassName#methodName`
- **Compile only**: `./mvnw compile`
- **Clean build directory**: `./mvnw clean`

## Architecture

### Technology Stack
- Spring Boot 4.0.1
- Java 25
- Spring Web MVC for REST APIs
- Spring Data JPA for persistence
- H2 Database (file-based for production, in-memory for tests)
- Jakarta Validation for request validation
- Hibernate ORM 7.2.0 with optimistic locking
- Configuration processor enabled for type-safe configuration properties

### Package Structure
The codebase follows a feature-based package structure under `dev.juanvaldivia.moneytrak`:
- `expenses/` - Expense management feature with controller, service, domain models, and DTOs

### Core Patterns

**Service Layer Pattern**: Interface-based services (e.g., `ExpenseService` interface with `LocalExpenseService` implementation) enable multiple implementations and easier testing.

**DTO Pattern**: Separate DTOs for API contracts:
- `ExpenseCreationDto` - Input validation with Jakarta Bean Validation annotations for POST requests
- `ExpenseUpdateDto` - Partial update DTO with version field for optimistic locking
- `ExpenseDto` - API response format with all fields including version and timestamps
- `Expense` - JPA entity (mutable class with @Version field)
- `ExpenseMapper` - Maps between DTOs and domain models

**Controller Design**: REST controllers use:
- `@Valid` for automatic validation of request bodies
- `ResponseEntity` for HTTP response control
- `ServletUriComponentsBuilder` for generating resource URIs in `Location` headers

### Domain Model Conventions
- Records are used for immutable DTOs (e.g., `ExpenseDto`, `ExpenseCreationDto`)
- JPA entities are mutable classes (e.g., `Expense` with @Entity annotation)
- `BigDecimal` for monetary amounts with precision constraints (11 digits, 2 decimal places)
- ISO 4217 currency codes validated with custom `@ValidCurrency` annotation
- `ZonedDateTime` for temporal data with timezone support (stored in UTC)
- UUID for entity identifiers (generated by JPA)
- `@Version` field for optimistic locking with automatic increment

### Validation Rules
Validation is declarative using Jakarta Validation annotations on DTOs:
- `@NotNull`, `@NotBlank` for required fields
- `@PastOrPresent` for date validation (rejects future dates)
- `@Size(max=500)` for description length
- `@DecimalMin("0.01")` for positive amounts
- `@Digits(integer=9, fraction=2)` for decimal precision
- Custom `@ValidCurrency` for ISO 4217 currency code validation
- Custom error messages provided for each validation rule

### API Versioning
REST endpoints are versioned using path prefix `/v1/` (e.g., `/v1/expenses`).

### API Endpoints
- `POST /v1/expenses` - Create new expense (returns 201 with Location header)
- `GET /v1/expenses` - List all expenses (reverse chronological order)
- `GET /v1/expenses/{id}` - Get single expense by ID
- `PUT /v1/expenses/{id}` - Update expense (requires version for optimistic locking)
- `DELETE /v1/expenses/{id}` - Delete expense (returns 204 No Content)

### Error Handling
Global exception handler (`@RestControllerAdvice`) provides consistent error responses:
- 400 Bad Request - Validation errors with field-level details
- 404 Not Found - Resource not found
- 409 Conflict - Optimistic lock version mismatch
- 500 Internal Server Error - Unexpected errors

Error response format: `{status, error, message, details[]}`

### Optimistic Locking
Uses JPA `@Version` field with automatic increment:
- Version starts at 0 on creation
- Increments on each update
- Concurrent updates with stale version return 409 Conflict
- EntityManager.flush() called after updates to ensure version increment

### Configuration
- `application.yaml` in `src/main/resources/` for Spring configuration
- Spring Boot Configuration Processor generates metadata for IDE autocomplete

## Active Technologies
- Java 25 + Spring Boot 4.0.1
- Spring Web MVC, Spring Data JPA, Jakarta Validation
- H2 database (file-based for persistence, in-memory for tests)
- Hibernate ORM 7.2.0 with optimistic locking
- Spring Boot Configuration Processor

## Test Coverage
- 32 integration tests covering all CRUD operations
- Tests verify validation, error handling, and optimistic locking
- Test profiles: `test` (in-memory H2), `default` (file-based H2)

## Recent Changes
- 001-expense-tracking: Complete CRUD implementation with optimistic locking
  - All 4 user stories implemented (Create, Retrieve, Update, Delete)
  - 32 passing integration tests
  - JavaDoc added to public APIs
  - Global exception handling with standardized error responses
